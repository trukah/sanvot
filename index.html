<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>RepeatableRepeatable QuantAI</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      background: linear-gradient(to bottom right, #001f3f, #00334d);
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 1rem;
      color: #e0faff;
      min-height: 100vh;
    }
    .container {
      width: 100%;
      max-width: 700px;
      background: rgba(0, 26, 51, 0.75);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(51,204,255,0.2);
      border-radius: 18px;
      box-shadow: 0 0 20px rgba(51,204,255,0.6);
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .branding {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo {
      font-size: 1.75rem;
      font-weight: bold;
      background: linear-gradient(to right, #33ccff, #006699);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .logo-badge {
      background: #00475a;
      color: #33ccff;
      padding: 0.25rem 0.75rem;
      border-radius: 0.75rem;
      font-weight: bold;
      font-size: 0.75rem;
    }
    h2 {
      text-align: center;
      color: #ccf2ff;
      font-size: 1.5rem;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
    }
    h2::before { content: '🔬'; font-size: 1.75rem; }

    label {
      font-size: 0.875rem;
      margin-bottom: 0.25rem;
      color: #aaddff;
      display: block;
    }
    input[type="number"] {
      width: 100%;
      padding: 0.75rem;
      border-radius: 0.75rem;
      border: 1px solid #33ccff;
      background: rgba(255,255,255,0.05);
      color: #e0faff;
      font-size: 0.875rem;
      transition: background 0.3s;
      -moz-appearance: textfield;
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    input[type="number"]:focus {
      background: rgba(255,255,255,0.15);
      box-shadow: 0 0 8px #33ccff;
      outline: none;
    }
    .session-options {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin: 0.75rem 0;
    }
    .session-options label {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.875rem;
      color: #b2e6ff;
      cursor: pointer;
    }
     .session-options input[type="radio"] {
        margin-right: 0.25rem;
     }

    button {
      width: 100%;
      padding: 0.75rem;
      background: linear-gradient(to right, #33ccff, #006699);
      color: #fff;
      border: none;
      border-radius: 0.75rem;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
      box-shadow: 0 2px 12px rgba(51,204,255,0.4);
    }
    button:hover {
      background: linear-gradient(to right, #00aaff, #004466);
    }
    .result-section {
      display: none;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1rem;
    }
    .result-combined {
      background: rgba(0, 204, 255, 0.1);
      padding: 1rem;
      border-left: 5px solid #33ccff;
      border-radius: 0.625rem;
      font-weight: bold;
      text-align: center;
      font-size: 1rem;
      box-shadow: 0 0 10px rgba(51,204,255,0.4);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    .result-combined span {
        display: inline-block;
        padding: 0.25rem 0.5rem;
    }

    .sentiment-signal-icon {
        display: inline-block;
        font-size: 1.5rem;
        line-height: 1;
        margin-left: 0.5rem;
        vertical-align: middle;
        text-shadow: 0 0 8px rgba(255,255,255,0.6);
        filter: drop-shadow(0 0 5px rgba(255,255,255,0.4));
    }
    .signal-be { color: #ef4444; filter: drop-shadow(0 0 5px rgba(239, 68, 68, 0.6)); }
    .signal-k { color: #facc15; filter: drop-shadow(0 0 5px rgba(250, 204, 21, 0.6)); }
    .signal-bu { color: #22c55e; filter: drop-shadow(0 0 5px rgba(34, 197, 94, 0.6)); }


    /* --- Existing Table Styles (used inside collapsible containers) --- */
    .tables {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1rem;
      width: 100%;
    }
    th, td {
      padding: 0.75rem;
      text-align: center;
      font-size: 0.875rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      color: #e0faff;
    }
    thead th { border-bottom: 2px solid rgba(255,255,255,0.2); }

    .table-distribusi th {
        background-color: rgba(239, 68, 68, 0.5);
        color: #ef4444;
    }
    .table-akumulasi th {
        background-color: rgba(34, 197, 94, 0.5);
        color: #22c55e;
    }
    /* --- End Existing Table Styles --- */


    /* --- MODIFIED CSS for the Note section to be collapsible --- */
    /* Removed direct styling on .note, moved to .note-content */
    /* .note {
      font-size: 0.8125rem;
      background: rgba(0,255,255,0.04);
      padding: 0.75rem;
      border-left: 4px solid #33ccff;
      border-radius: 0.5rem;
      text-align: justify;
      box-shadow: 0 0 10px rgba(51,204,255,0.4);
    } */

    .note-card { /* New container for the note */
        background: rgba(51,204,255,0.05); /* Same background as other cards */
        border: 1px solid rgba(51,204,255,0.1); /* Same border as other cards */
        border-radius: 0.75rem; /* Same border-radius as other cards */
        overflow: hidden;
        box-shadow: 0 0 10px rgba(51,204,255,0.4); /* Same shadow as other cards */
        margin-bottom: 1rem; /* Space below the card */
    }

    .note-card-header { /* Header for the note card */
        padding: 0.75rem 1.5rem;
        background: rgba(51,204,255,0.1); /* Same background as other card headers */
        color: #ccf2ff; /* Same text color as other card headers */
        font-weight: bold;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.3s ease;
    }

    .note-card-header:hover {
        background: rgba(51,204,255,0.2); /* Same hover effect */
    }

    .note-card-header .arrow { /* Arrow icon style */
        transition: transform 0.3s ease;
    }

    .note-card-header.expanded .arrow {
        transform: rotate(180deg);
    }

    .note-content { /* Content area for the note */
        padding: 0 1.5rem; /* Horizontal padding */
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out, padding 0.3s ease-out;
        color: #b2e6ff; /* Text color for the note content */
        text-align: justify; /* Original text alignment */
    }

    .note-content.expanded {
        max-height: 500px; /* Sufficiently large to show note text */
        padding: 0.75rem 1.5rem; /* Padding when expanded - matches original .note padding */
    }

    .note-content p { /* Style for paragraphs inside the note content */
        margin-bottom: 0.5rem; /* Space between paragraphs */
    }
     .note-content p:last-child {
         margin-bottom: 0; /* No bottom margin for the last paragraph */
     }

    /* --- END MODIFIED CSS --- */


    /* --- Existing CSS for the first sentiment visualization (line with marker) --- */
    #sentiment_visualization_area {
        margin-top: 1rem;
        margin-bottom: 1rem;
        background: rgba(51,204,255,0.05);
        border: 1px solid rgba(51,204,255,0.1);
        border-radius: 0.75rem;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        opacity: 0;
        transform: translateY(10px);
        pointer-events: none;
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        box-shadow: 0 0 10px rgba(51,204,255,0.4);
    }
    #sentiment_visualization_area.visualization-visible {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
    }

    .sentiment-line-container {
        position: relative;
        width: 100%;
        height: 30px;
        padding: 0 10px;
        display: flex;
        align-items: center;
        background: none;
        border: none;
        border-radius: 0;
        box-shadow: none;
    }
    .sentiment-line {
        position: static;
        flex-grow: 1;
        height: 8px;
        border-radius: 4px;
        background: linear-gradient(to right,
            #ef4444 0%, /* Bearish */
            #ef4444 40%,
            #facc15 40%, /* Konsolidasi */
            #facc15 60%,
            #22c55e 60%, /* Bullish */
            #22c55e 100%
        );
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    .cf-marker {
        position: absolute;
        top: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.2rem;
        line-height: 1;
        transition: left 0.5s ease-in-out, color 0.3s ease-in-out;
        z-index: 10;
        text-shadow: 0 0 5px rgba(51,204,255,0.5);
    }
    .cf-percentage-text { /* This class name is from the user's original code */
        position: absolute;
        top: 100%;
        margin-top: 5px;
        font-size: 0.8rem;
        font-weight: 600;
        transform: translateX(-50%);
        transition: left 0.5s ease-in-out, color 0.3s ease-in-out;
        white-space: nowrap;
        background-color: rgba(0, 49, 74, 0.9);
        color: #e0faff !important;
        padding: 2px 6px;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        z-index: 5;
        border: 1px solid rgba(51,204,255,0.1);
    }

    .marker-be, .text-be { color: #ef4444; }
    .marker-k, .text-k { color: #facc15; }
    .marker-bu, .text-bu { color: #22c55e; }


    /* --- MODIFIED CSS for the Sentiment Percentage Bar (Darker Theme) --- */
    #sentiment_percentage_bar_area {
        margin-top: 1rem;
        margin-bottom: 1rem;
        background: rgba(0, 49, 74, 0.5);
        border: 1px solid rgba(51,204,255,0.3);
        border-radius: 0.75rem;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        opacity: 0;
        transform: translateY(10px);
        pointer-events: none;
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        box-shadow: 0 0 15px rgba(51,204,255,0.5);
    }
    #sentiment_percentage_bar_area.visualization-visible {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
    }

    .sentiment-percentage-bar-container {
        width: 100%;
        height: 25px;
        display: flex;
        overflow: hidden;
        border-radius: 4px;
        background-color: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.3);
    }

    .sentiment-percentage-segment {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.8em;
        color: white;
        transition: width 0.5s ease-in-out;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: clip;
    }

    .sentiment-percentage-segment.bullish {
        background-color: #22c55e;
    }

    .sentiment-percentage-segment.bearish {
        background-color: #ef4444;
    }

    .sentiment-percentage-label {
        font-size: 0.9em;
        color: #e0faff;
        text-align: center;
        margin-top: 5px;
    }
    /* --- END MODIFIED CSS --- */


    /* --- CSS for Collapsible Tables --- */
    .table-card {
        background: rgba(51,204,255,0.05);
        border: 1px solid rgba(51,204,255,0.1);
        border-radius: 0.75rem;
        overflow: hidden;
        box-shadow: 0 0 10px rgba(51,204,255,0.4);
        margin-bottom: 1rem;
    }

    .table-card-header {
        padding: 0.75rem 1.5rem;
        background: rgba(51,204,255,0.1);
        color: #ccf2ff;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.3s ease;
    }

    .table-card-header:hover {
        background: rgba(51,204,255,0.2);
    }

    .table-card-header .arrow {
        transition: transform 0.3s ease;
    }

    .table-card-header.expanded .arrow {
        transform: rotate(180deg);
    }

    .table-content {
        padding: 0 1.5rem;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out, padding 0.3s ease-out;
    }

    .table-content.expanded {
        max-height: 500px;
        padding: 1rem 1.5rem;
    }

    .table-content table {
        width: 100%;
        border-collapse: collapse;
        background: rgba(255,255,255,0.05);
        border-radius: 0.5rem;
        overflow: hidden;
        box-shadow: 0 0 10px rgba(51,204,255,0.4);
        margin: 0;
        padding: 0;
    }
    /* --- END CSS --- */


    .info-card {
        background: rgba(51,204,255,0.05);
        border: 1px solid rgba(51,204,255,0.1);
        border-radius: 0.75rem;
        overflow: hidden;
        box-shadow: 0 0 10px rgba(51,204,255,0.4);
        margin-bottom: 1rem;
    }

    .info-card-header {
        padding: 0.75rem 1.5rem;
        background: rgba(51,204,255,0.1);
        color: #ccf2ff;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.3s ease;
    }

    .info-card-header:hover {
        background: rgba(51,204,255,0.2);
    }

    .info-card-header .arrow {
        transition: transform 0.3s ease;
    }

    .info-card-header.expanded .arrow {
        transform: rotate(180deg);
    }

    .info-card-content {
        padding: 0 1.5rem;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out, padding 0.3s ease-out;
        color: #b2e6ff;
        text-align: justify;
    }

    .info-card-content.expanded {
        max-height: 500px;
        padding: 1rem 1.5rem;
    }
     .info-card-content p {
         margin-bottom: 0.5rem;
     }
     .info-card-content p:last-child {
         margin-bottom: 0;
     }

     /* Existing Responsive adjustments (kept as per user's original code) */
     @media (max-width: 640px) {
         .container {
             padding: 1rem;
             gap: 0.75rem;
         }
         .logo {
             font-size: 1.5rem;
         }
         .logo-badge {
             font-size: 0.65rem;
             padding: 0.2rem 0.5rem;
         }
         h2 {
             font-size: 1.3rem;
         }
         h2::before {
             font-size: 1.5rem;
         }
         label {
             font-size: 0.8rem;
         }
         input[type="number"], button {
             padding: 0.6rem;
             font-size: 0.9rem;
         }
         .session-options label {
             font-size: 0.8rem;
         }
         .result-combined {
             font-size: 0.9rem;
             padding: 0.8rem;
         }
         .tables {
             grid-template-columns: 1fr; /* Stack tables on small screens */
         }
         th, td {
             padding: 0.6rem;
             font-size: 0.8rem;
         }
         .note { /* Original note style for responsiveness */
             font-size: 0.75rem;
             padding: 0.6rem;
         }
         /* Adjusted padding for visualization areas on small screens */
         #sentiment_visualization_area, #sentiment_percentage_bar_area {
             padding: 0.8rem;
         }
         .sentiment-line-container {
             height: 25px;
         }
         .cf-marker {
             font-size: 1rem;
         }
         .cf-percentage-text {
             font-size: 0.7rem;
         }
         /* Responsive for the new bar */
         .sentiment-percentage-bar-container {
             height: 20px;
         }
         .sentiment-percentage-segment {
             font-size: 0.7em;
         }
         .sentiment-percentage-label {
             font-size: 0.8em;
         }
         .info-card-header, .table-card-header, .note-card-header { /* Apply responsive styles to all headers */
             padding: 0.6rem 1rem;
             font-size: 0.9rem;
         }
         .info-card-content.expanded, .table-content.expanded, .note-content.expanded { /* Apply responsive styles to all expanded content */
             padding: 0.8rem 1rem;
         }
         .info-card-content p, .note-content p { /* Apply responsive styles to paragraph inside note */
             font-size: 0.85rem;
         }
     }


  </style>
</head>
<body>
  <div class="container">
    <div class="branding">
      <div class="logo">Quantai</div> <div class="logo-badge">SanClass</div> </div>
    <h2>Sanva Indonesia</h2>

    <div class="info-card" id="infoCard">
        <div class="info-card-header" id="infoCardHeader">
            <span>Cara Penggunaan</span> <span class="arrow">▼</span> </div>
        <div class="info-card-content" id="infoCardContent">
            <p>Masukkan nilai Volatility Factor (VF) dan Close Factor (CF) pada kolom yang tersedia.</p>
            <p>Pilih Sesi Trading (ER, AM, atau AS) yang sesuai. Pilihan sesi ini akan menentukan nilai Smooth Factor (SF).</p>
            <p>Klik tombol "Hitung" untuk menampilkan hasil analisis berdasarkan Sanva Theory.</p>
            <p>Hasil akan menampilkan Pivot Point (PP), Sesi, Sinyal Sentimen, Visualisasi Sentimen, Visualisasi Sentimen Persentase, serta tabel Distribusi dan Akumulasi pada level-level kunci (dapat diklik untuk ditampilkan).</p>
            <p>Analisis ini bersifat eksperimental dan bukan merupakan nasihat keuangan. Selalu gunakan manajemen risiko.</p>
        </div>
    </div>

    <div>
      <label for="vf">Volatility Factor (VF)</label> <input type="number" id="vf" step="0.01" placeholder="Contoh: 3245.36"> </div>
    <div>
      <label for="cf">Close Factor (CF)</label> <input type="number" id="cf" step="0.01" placeholder="Contoh: 3237.53"> </div>
    <div>
      <label>Sesi Trading (Pilih Salah Satu):</label> <div class="session-options"> <label><input type="radio" name="session" value="8"> ER</label> <label><input type="radio" name="session" value="13"> AM</label> <label><input type="radio" name="session" value="21" checked> AS</label> </div>
    </div>

    <button type="button" onclick="calculate()">Hitung</button>

    <div id="result" class="result-section">
      <div class="result-combined" id="pivotSesi">
          </div>

      <div id="sentiment_visualization_area" class="visualization-hidden">
          <div class="sentiment-line-container">
              <div class="sentiment-line"></div>
              <span id="cf_marker" class="cf-marker">●</span>
              <span id="cf_percentage" class="cf-percentage-text">0%</span>
          </div>
      </div>

      <div id="sentiment_percentage_bar_area" class="visualization-hidden">
  
          <div class="sentiment-percentage-bar-container">
              <div class="sentiment-percentage-segment bullish" id="sentiment-bullish-pct-segment"></div>
              <div class="sentiment-percentage-segment bearish" id="sentiment-bearish-pct-segment"></div>
          </div>
      </div>
      <div class="tables">
          <div class="table-card" id="distribusiTableCard">
              <div class="table-card-header" id="distribusiTableHeader">
                  <span>Distribusi</span> <span class="arrow">▼</span>
              </div>
              <div class="table-content" id="distribusiTableContent">
                  <table class="table-distribusi">
                      <thead><tr><th colspan="2">Distribusi</th></tr></thead>
                      <tbody>
                          <tr><td>0.500</td><td id="dist0_5"></td></tr>
                          <tr><td>1.618</td><td id="dist1_618"></td></tr>
                          <tr><td>2.618</td><td id="dist2_618"></td></tr>
                          <tr><td>4.236</td><td id="dist4_236"></td></tr>
                      </tbody>
                  </table>
              </div>
          </div>

          <div class="table-card" id="akumulasiTableCard">
              <div class="table-card-header" id="akumulasiTableHeader">
                  <span>Akumulasi</span> <span class="arrow">▼</span>
              </div>
              <div class="table-content" id="akumulasiTableContent">
                  <table class="table-akumulasi">
                      <thead><tr><th colspan="2">Akumulasi</th></tr></thead>
                      <tbody>
                          <tr><td>0.500</td><td id="acc0_5"></td></tr>
                          <tr><td>1.618</td><td id="acc1_618"></td></tr>
                          <tr><td>2.618</td><td id="acc2_618"></td></tr>
                          <tr><td>4.236</td><td id="acc4_236"></td></tr>
                      </tbody>
                  </table>
              </div>
          </div>
      </div>
      <div class="note-card" id="noteCard">
          <div class="note-card-header" id="noteCardHeader">
              <span>Informasi Perhitungan</span> <span class="arrow">▼</span>
          </div>
          <div class="note-content" id="noteContent">
              <p>Perhitungan berdasarkan model Sanva Theory. Sesuaikan sesi dan input VF & CF dengan data yang relevan. Hasil ini bersifat informatif dan eksperimental, bukan merupakan sinyal keuangan atau nasihat investasi. Selalu terapkan manajemen risiko dan lakukan analisis mandiri sebelum mengambil keputusan trading. <span id="marketSession"></span></p>
          </div>
      </div>
      </div>
  </div>

  <script>
    let lastCalculatedLS = null;
    let lastCalculatedHS = null;
    let lastCalculatedCF = null;
    let lastCalculatedPP = null;
    let lastCalculatedDist4236 = null; // Store Dist 4.236 value for new sentiment calculation
    let lastCalculatedAcc4236 = null; // Store Acc 4.236 value for new sentiment calculation


    function calculate() {
      const vf = parseFloat(document.getElementById('vf').value);
      const cf = parseFloat(document.getElementById('cf').value);

      const sessions = document.querySelectorAll('input[name="session"]');
      let smoothFactor = 0;
      let kodeNegara = '';
      sessions.forEach(s => {
          if (s.checked) {
              smoothFactor = parseFloat(s.value);
              kodeNegara = s.parentElement.textContent.trim();
          }
      });

      // Hide visualization areas initially on new calculation
      const visualizationArea1 = document.getElementById('sentiment_visualization_area');
      const visualizationArea2 = document.getElementById('sentiment_percentage_bar_area');
       if (visualizationArea1) {
            visualizationArea1.classList.remove('visualization-visible');
            visualizationArea1.classList.add('visualization-hidden');
       }
        if (visualizationArea2) {
            visualizationArea2.classList.remove('visualization-visible');
            visualizationArea2.classList.add('visualization-hidden');
        }

        // Hide table contents when recalculating
        const distribusiTableContent = document.getElementById('distribusiTableContent');
        const distribusiTableHeader = document.getElementById('distribusiTableHeader');
        const akumulasiTableContent = document.getElementById('akumulasiTableContent');
        const akumulasiTableHeader = document.getElementById('akumulasiTableHeader');

        if (distribusiTableContent) {
             distribusiTableContent.classList.remove('expanded');
             distribusiTableHeader.classList.remove('expanded');
        }
         if (akumulasiTableContent) {
             akumulasiTableContent.classList.remove('expanded');
             akumulasiTableHeader.classList.remove('expanded');
         }

        // Hide note content when recalculating
        const noteContent = document.getElementById('noteContent');
        const noteCardHeader = document.getElementById('noteCardHeader');
        if (noteContent) {
            noteContent.classList.remove('expanded');
            noteCardHeader.classList.remove('expanded');
        }


      if (isNaN(vf) || isNaN(cf)) {
        showMessageBox('Lebokna nilai VF karo CF sing bener, Lur!');
        document.getElementById('result').style.display = 'none';
        // Reset last calculated values
        lastCalculatedLS = null;
        lastCalculatedHS = null;
        lastCalculatedCF = null;
        lastCalculatedPP = null;
        lastCalculatedDist4236 = null;
        lastCalculatedAcc4236 = null;
        return;
      }

      const hs = vf + smoothFactor;
      const ls = vf - smoothFactor;

      const pp = (hs + ls + cf) / 3;

      const range = hs - ls;

      // Store last calculated values for resize handling and new sentiment calculation
      lastCalculatedLS = ls;
      lastCalculatedHS = hs;
      lastCalculatedCF = cf;
      lastCalculatedPP = pp;


      let sentimentSignalClass = '';
      let sentimentText = '';

      // ORIGINAL Sentiment signal logic based on CF vs LS/HS from user's code - UNCHANGED
      if (cf > ls && cf > hs) {
          sentimentSignalClass = 'signal-bu';
          sentimentText = 'BULLISH';
      } else if (cf < ls && cf < hs) {
          sentimentSignalClass = 'signal-be';
          sentimentText = 'BEARISH';
      } else {
          sentimentSignalClass = 'signal-k';
          sentimentText = 'KONSOLIDASI';
      }


      // ORIGINAL Output format for pivotSesi card from user's code - UNCHANGED
      const pivotSesiElement = document.getElementById('pivotSesi');
      pivotSesiElement.innerHTML = `
          <span>PP: ${pp.toFixed(2)}</span>
          
          <span class="${sentimentSignalClass}">${sentimentText}</span>
          `;

      // Update the market session span inside the note content
      const marketSessionSpan = document.getElementById('marketSession');
      if (marketSessionSpan) {
          marketSessionSpan.textContent = `Market Session: ${kodeNegara}`;
      }


      const calcNode = (ppValue, rangeValue, multiplier, operation) => {
          if (rangeValue === 0) {
              return ppValue.toFixed(2); // Or handle as needed for zero range
          }
          if (operation === '+') {
              return (ppValue + rangeValue * multiplier).toFixed(2);
          } else if (operation === '-') {
              return (ppValue - rangeValue * multiplier).toFixed(2);
          }
          return 'Error'; // Should not happen with '+' or '-'
      };

      const multipliers = {
          '0.5': 0.5,
          '1.618': 1.618,
          '2.618': 2.618,
          '4.236': 4.236
      };

      // Calculate and display table values (These elements are inside the new collapsible structure)
      const dist4_236 = parseFloat(calcNode(pp, range, multipliers['4.236'], '+'));
      const acc4_236 = parseFloat(calcNode(pp, range, multipliers['4.236'], '-'));

      document.getElementById('dist0_5').textContent  = calcNode(pp, range, multipliers['0.5'], '+');
      document.getElementById('dist1_618').textContent = calcNode(pp, range, multipliers['1.618'], '+');
      document.getElementById('dist2_618').textContent = calcNode(pp, range, multipliers['2.618'], '+');
      document.getElementById('dist4_236').textContent = dist4_236.toFixed(2); // Use calculated value

      document.getElementById('acc0_5').textContent  = calcNode(pp, range, multipliers['0.5'], '-');
      document.getElementById('acc1_618').textContent = calcNode(pp, range, multipliers['1.618'], '-');
      document.getElementById('acc2_618').textContent = calcNode(pp, range, multipliers['2.618'], '-');
      document.getElementById('acc4_236').textContent = acc4_236.toFixed(2); // Use calculated value

      // Store these specific values for the new sentiment calculation
      lastCalculatedDist4236 = dist4_236;
      lastCalculatedAcc4236 = acc4_236;


      // Show the result section
      document.getElementById('result').style.display = 'flex';

      // Update both visualizations
      updateSentimentVisualization(lastCalculatedLS, lastCalculatedHS, lastCalculatedCF, lastCalculatedPP);
      updateSentimentPercentageBar(lastCalculatedCF, lastCalculatedAcc4236, lastCalculatedDist4236); // Call the new function

    }

    // Existing Function to update the first sentiment visualization (line with marker)
    // This function remains unchanged from the user's original code.
    function updateSentimentVisualization(ls, hs, cf, pp) {
        const visualizationArea = document.getElementById('sentiment_visualization_area');
        const cfMarker = document.getElementById('cf_marker');
        const cfPercentageText = document.getElementById('cf_percentage'); // Element for percentage text
        const sentimentLineContainer = visualizationArea ? visualizationArea.querySelector('.sentiment-line-container') : null;

        if (!visualizationArea || !cfMarker || !cfPercentageText || !sentimentLineContainer || isNaN(ls) || isNaN(hs) || isNaN(cf) || isNaN(pp)) {
             visualizationArea.classList.remove('visualization-visible');
             visualizationArea.classList.add('visualization-hidden');
             return;
        }

        const range = hs - ls;
        // Handle zero or negative range - hide visualization
        if (range <= 0) {
             visualizationArea.classList.remove('visualization-visible');
             visualizationArea.classList.add('visualization-hidden');
             return;
        }

        // Calculate position of CF relative to LS and HS range (0% at LS, 100% at HS)
        // This calculation and the percentage displayed in cf_percentage_text are from the original code.
        let positionInLHS = ((cf - ls) / range) * 100;

        // Clamp the position to be between 0% and 100%
        let visualPositionPercent = Math.max(0, Math.min(100, positionInLHS));

        // Calculate percentage for the text label (based on the original code's calculation)
        let sentimentPercentageForLabel = ((pp - cf) / range) * 100;


        let colorClass = '';
        // Determine color class based on CF position relative to LS/HS (matching the original signal logic)
        if (cf > ls && cf > hs) {
            colorClass = 'bu'; // Bullish signal
        } else if (cf < ls && cf < hs) {
            colorClass = 'be'; // Bearish signal
        } else {
            colorClass = 'k'; // Konsolidasi signal
        }


        const containerRect = sentimentLineContainer.getBoundingClientRect();
        const containerWidth = containerRect.width;
        const linePadding = 10; // Corresponds to padding in CSS
        const lineWidth = containerWidth - 2 * linePadding;

        // Calculate pixel position based on the clamped percentage within LS-HS range
        let calculatedPixelPositionInLine = (visualPositionPercent / 100) * lineWidth;

        // Final position for the marker, accounting for container padding
        const finalMarkerLeftPosition = linePadding + calculatedPixelPositionInLine;

        cfMarker.style.left = `${finalMarkerLeftPosition}px`;
        cfPercentageText.style.left = `${finalMarkerLeftPosition}px`;


        cfMarker.className = `cf-marker marker-${colorClass}`;
        cfPercentageText.className = `cf-percentage-text text-${colorClass}`;

        // Display the percentage calculated by the original code's logic
        cfPercentageText.innerHTML = `${sentimentPercentageForLabel.toFixed(1)}%`;


        if (!visualizationArea.classList.contains('visualization-visible')) {
             visualizationArea.classList.remove('visualization-hidden');
             visualizationArea.classList.add('visualization-visible');
        }
    }


    // NEW Function to update the Sentiment Percentage Bar
    function updateSentimentPercentageBar(cf, acc4236, dist4236) {
        const visualizationArea = document.getElementById('sentiment_percentage_bar_area');
        const bullishSegment = document.getElementById('sentiment-bullish-pct-segment');
        const bearishSegment = document.getElementById('sentiment-bearish-pct-segment');

        // Ensure all necessary elements and values exist
        if (!visualizationArea || !bullishSegment || !bearishSegment || isNaN(cf) || isNaN(acc4236) || isNaN(dist4236)) {
             visualizationArea.classList.remove('visualization-visible');
             visualizationArea.classList.add('visualization-hidden');
             return;
        }

        const denominator = dist4236 - acc4236;

        // Handle case where denominator is zero or invalid
        if (denominator === 0 || isNaN(denominator)) {
            // Hide the visualization if the calculation is not possible
            visualizationArea.classList.remove('visualization-visible');
            visualizationArea.classList.add('visualization-hidden');
            return;
        }

        // Calculate the sentiment percentage using the provided formula
        // Sentiment % = ((CF – Akumulasi 4.236) / (Distribusi 4.236 – Akumulasi 4.236)) × 100
        let sentimentPercentage = ((cf - acc4236) / denominator) * 100;

        // Clamp the percentage between 0 and 100
        sentimentPercentage = Math.max(0, Math.min(100, sentimentPercentage));

        const bullishPct = sentimentPercentage;
        const bearishPct = 100 - sentimentPercentage;

        // Set widths for the segments
        bullishSegment.style.width = bullishPct + '%';
        bearishSegment.style.width = bearishPct + '%';

        // Set text content for the segments (only if wide enough)
        bullishSegment.textContent = bullishPct > 5 ? bullishPct.toFixed(1) + '%' : '';
        bearishSegment.textContent = bearishPct > 5 ? bearishPct.toFixed(1) + '%' : '';

        // Show the visualization area
        if (!visualizationArea.classList.contains('visualization-visible')) {
             visualizationArea.classList.remove('visualization-hidden');
             visualizationArea.classList.add('visualization-visible');
        }
    }


    function showMessageBox(message) {
        alert(message); // Using alert as per existing code
    }


    document.addEventListener('DOMContentLoaded', function() {
        // Existing Info Card Toggle
        const infoCardHeader = document.getElementById('infoCardHeader');
        const infoCardContent = document.getElementById('infoCardContent');

        if (infoCardHeader && infoCardContent) {
            infoCardHeader.addEventListener('click', function() {
                const isExpanded = infoCardContent.classList.contains('expanded');
                if (isExpanded) {
                    infoCardContent.classList.remove('expanded');
                    infoCardHeader.classList.remove('expanded');
                } else {
                    infoCardContent.classList.add('expanded');
                    infoCardHeader.classList.add('expanded');
                }
            });
        }

        // Collapsible Table Toggle Logic
        const distribusiTableHeader = document.getElementById('distribusiTableHeader');
        const distribusiTableContent = document.getElementById('distribusiTableContent');
        const akumulasiTableHeader = document.getElementById('akumulasiTableHeader');
        const akumulasiTableContent = document.getElementById('akumulasiTableContent');

        if (distribusiTableHeader && distribusiTableContent) {
            distribusiTableHeader.addEventListener('click', function() {
                const isExpanded = distribusiTableContent.classList.contains('expanded');
                if (isExpanded) {
                    distribusiTableContent.classList.remove('expanded');
                    distribusiTableHeader.classList.remove('expanded');
                } else {
                    distribusiTableContent.classList.add('expanded');
                    distribusiTableHeader.classList.add('expanded');
                }
            });
        }

        if (akumulasiTableHeader && akumulasiTableContent) {
            akumulasiTableHeader.addEventListener('click', function() {
                const isExpanded = akumulasiTableContent.classList.contains('expanded');
                if (isExpanded) {
                    akumulasiTableContent.classList.remove('expanded');
                    akumulasiTableHeader.classList.remove('expanded');
                } else {
                    akumulasiTableContent.classList.add('expanded');
                    akumulasiTableHeader.classList.add('expanded');
                }
            });
        }

        // NEW Collapsible Note Toggle Logic
        const noteCardHeader = document.getElementById('noteCardHeader');
        const noteContent = document.getElementById('noteContent');

        if (noteCardHeader && noteContent) {
            noteCardHeader.addEventListener('click', function() {
                const isExpanded = noteContent.classList.contains('expanded');
                if (isExpanded) {
                    noteContent.classList.remove('expanded');
                    noteCardHeader.classList.remove('expanded');
                } else {
                    noteContent.classList.add('expanded');
                    noteCardHeader.classList.add('expanded');
                }
            });
        }
    });

    // Handle window resize to update visualization positions/widths
    window.addEventListener('resize', () => {
        // Update the first visualization (existing)
        const visualizationArea1 = document.getElementById('sentiment_visualization_area');
         if (visualizationArea1 && visualizationArea1.classList.contains('visualization-visible') &&
             lastCalculatedLS !== null && lastCalculatedHS !== null && lastCalculatedCF !== null && lastCalculatedPP !== null) {
             updateSentimentVisualization(lastCalculatedLS, lastCalculatedHS, lastCalculatedCF, lastCalculatedPP);
         }

        // Update the new sentiment percentage bar
         const visualizationArea2 = document.getElementById('sentiment_percentage_bar_area');
         if (visualizationArea2 && visualizationArea2.classList.contains('visualization-visible') &&
             lastCalculatedCF !== null && lastCalculatedAcc4236 !== null && lastCalculatedDist4236 !== null) {
             updateSentimentPercentageBar(lastCalculatedCF, lastCalculatedAcc4236, lastCalculatedDist4236);
         }
    });


  </script>

</body>
</html>
